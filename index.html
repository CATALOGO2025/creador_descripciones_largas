<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Descripciones HTML con IA</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Calibri, sans-serif; }
    h1 {
      background-color: #00b5e2;
      color: white;
      padding: 20px;
      border-radius: 8px;
    }
    hr {
      margin: 40px 0;
      border: none;
      height: 2px;
      background-color: #ccc;
    }
    .formulario {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }
    .formulario label {
      display: block;
      margin-top: 10px;
    }
    .formulario input, .formulario button {
      margin-top: 5px;
      padding: 6px;
      width: 100%;
      box-sizing: border-box;
    }
    #preview {
      margin-top: 20px;
      padding: 20px;
      border: 2px solid #00b5e2;
      background: #f0faff;
      border-radius: 10px;
      font-size: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    #progresoContainer {
      display: none;
      margin: 20px 0;
    }
    #barraProgreso {
      width: 0%;
      height: 20px;
      background-color: #00b5e2;
      color: white;
      text-align: center;
      line-height: 20px;
    }
    #notificacion {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #00b5e2;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-size: 14px;
      display: none;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <h1>üèçÔ∏è Generador de Descripciones para eCommerce</h1>
  <hr>

  <div class="formulario">
    <h2>üßæ Ingreso individual de datos</h2>
    <label>Clave API de OpenAI:</label>
    <input id="apiKeyIndividual" type="password">
    <label>Nombre:</label>
    <input id="nombre">
    <label>Marca:</label>
    <input id="marca">
    <label>Material:</label>
    <input id="material">
    <label>Dise√±o:</label>
    <input id="diseno">
    <label>Dimensiones:</label>
    <input id="dimensiones">
    <label>Palabras clave:</label>
    <input id="palabras">
    <button onclick="generarIndividual()">Generar descripci√≥n</button>
    <button onclick="descargarHTML()">üíæ Descargar como HTML</button>
    <div id="preview">
      <strong>üîç Vista previa:</strong>
      <div id="descripcionGenerada">Esperando generaci√≥n...</div>
    </div>
  </div>

  <hr>

  <div class="formulario">
    <h2>üìÇ Carga masiva desde Excel</h2>
    <label>Clave API de OpenAI:</label>
    <input id="apiKey" type="password">
    <label>Selecciona tu archivo Excel:</label>
    <input type="file" id="fileInput">
    <button onclick="procesarArchivo()">Generar descripciones masivas</button>
    <button onclick="generarArchivoEjemplo()">üì• Descargar archivo de ejemplo</button>
    <div id="progresoContainer">
      <div id="barraProgreso">0%</div>
    </div>
  </div>

  <div id="notificacion"></div>

  <script>
    function mostrarNotificacion(mensaje) {
      const noti = document.getElementById("notificacion");
      noti.textContent = mensaje;
      noti.style.display = "block";
      setTimeout(() => {
        noti.style.display = "none";
      }, 3000);
    }

    function generarArchivoEjemplo() {
      const wb = XLSX.utils.book_new();
      const data = [["sku", "nombre", "marca", "material", "dise√±o", "dimensiones", "palabrasClave"],
                    ["123456", "Polera b√°sica", "Paris Basics", "Algod√≥n", "Casual", "M-L-XL", "c√≥moda, b√°sica, algod√≥n, verano"]];
      const ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, "Productos");
      XLSX.writeFile(wb, "ejemplo_productos.xlsx");
    }

    function procesarArchivo() {
      const file = document.getElementById("fileInput").files[0];
      const apiKey = document.getElementById("apiKey").value.trim();
      if (!file || !apiKey) {
        mostrarNotificacion("‚ö†Ô∏è Debes subir un archivo y una clave API.");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const productos = XLSX.utils.sheet_to_json(sheet);

        const resultados = [];
        let procesados = 0;
        document.getElementById("progresoContainer").style.display = "block";

        function actualizarProgreso() {
          const porcentaje = Math.round((procesados / productos.length) * 100);
          const barra = document.getElementById("barraProgreso");
          barra.style.width = porcentaje + "%";
          barra.textContent = porcentaje + "%";
        }

        function procesarProducto(producto, index) {
          const prompt = `Genera una descripci√≥n HTML amigable, semiformal y vendible para un producto con los siguientes datos:\nNombre: ${producto.nombre || ''}\nMarca: ${producto.marca || ''}\nMaterial: ${producto.material || ''}\nDise√±o: ${producto["dise√±o"] || ''}\nDimensiones: ${producto.dimensiones || ''}\nPalabras clave: ${producto.palabrasClave || ''}`;

          return fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: "gpt-3.5-turbo",
              messages: [{ role: "user", content: prompt }],
              temperature: 0.7
            })
          })
          .then(res => res.json())
          .then(data => {
            const descripcion = data.choices?.[0]?.message?.content || "Error generando la descripci√≥n.";
            resultados.push({ sku: producto.sku || `producto_${index + 1}`, descripcion });
          })
          .catch(() => {
            resultados.push({ sku: producto.sku || `producto_${index + 1}`, descripcion: "Error generando la descripci√≥n." });
          })
          .finally(() => {
            procesados++;
            actualizarProgreso();
            if (procesados === productos.length) exportarResultados();
          });
        }

        function exportarResultados() {
          const wb = XLSX.utils.book_new();
          const data = [["SKU", "Descripci√≥n Larga"], ...resultados.map(p => [p.sku, p.descripcion])];
          const ws = XLSX.utils.aoa_to_sheet(data);
          XLSX.utils.book_append_sheet(wb, ws, "Descripciones");
          XLSX.writeFile(wb, "descripciones_generadas.xlsx");
          mostrarNotificacion("‚úÖ Archivo generado correctamente.");
        }

        productos.forEach((p, i) => procesarProducto(p, i));
      };
      reader.readAsArrayBuffer(file);
    }

    function generarIndividual() {
      const nombre = document.getElementById("nombre").value;
      const marca = document.getElementById("marca").value;
      const material = document.getElementById("material").value;
      const diseno = document.getElementById("diseno").value;
      const dimensiones = document.getElementById("dimensiones").value;
      const palabras = document.getElementById("palabras").value;
      const apiKey = document.getElementById("apiKeyIndividual").value.trim();

      const prompt = `Genera una descripci√≥n HTML amigable, semiformal y vendible para un producto con los siguientes datos:\nNombre: ${nombre}\nMarca: ${marca}\nMaterial: ${material}\nDise√±o: ${diseno}\nDimensiones: ${dimensiones}\nPalabras clave: ${palabras}`;

      fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [{ role: "user", content: prompt }],
          temperature: 0.7
        })
      })
      .then(res => res.json())
      .then(data => {
        const descripcion = data.choices?.[0]?.message?.content || "Error generando la descripci√≥n.";
        document.getElementById("descripcionGenerada").innerHTML = descripcion;
      })
      .catch(err => {
        document.getElementById("descripcionGenerada").innerHTML = "‚ùå Error generando la descripci√≥n.";
      });
    }

    function descargarHTML() {
      const contenido = document.getElementById("descripcionGenerada").innerHTML;
      const blob = new Blob([contenido], { type: 'text/html' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "descripcion.html";
      link.click();
    }
  </script>
</body>
</html>
